---
title: 'Data Cleaning'
author: "Matt Steele"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
---

------------------------------------------------------------------------

## Resources

-   [Tidyverse Documentation](https://www.tidyverse.org/)

-   [O'Reilly Learning
    Platform](https://databases.lib.wvu.edu/connect/1540334373)

    -   R for Data Science, 2nd Edition

    -   R Programming for Statistics and Data Science

------------------------------------------------------------------------

```{r}
#| label: working directory
#| include: false

setwd("path_to_folder")


```

<br />

# Part 1: About Tidyverse

```{r}
#| label: install tidyverse
#| eval: false

install.packages("tidyverse")

```



```{r}
#| label: load tidyverse
#| eval: false

library(tidyverse)

```

Tidyverse is a collection of packages focused on data analysis and data
visualizations that share an underlying design philosophy, grammar, and
data structures.

|                                                     |                                                                   |
|-------------------------|-----------------------------------------------|
| [tibble](https://tibble.tidyverse.org/)             | lighter and more user-friendly version of data frames             |
| [tidyr](https://tidyr.tidyverse.org/)               | create tidy and meaningfully arranged data                        |
| [readr](https://readr.tidyverse.org/)               | better importation of data into R                                 |
| [ggplot](https://ggplot2.tidyverse.org/)            | data visualization functions                                      |
| [dplyr](https://dplyr.tidyverse.org/)               | data manipulation tools                                           |
| [lubridate](https://lubridate.tidyverse.org/)       | clean dates and times                                             |
| [purr](https://purrr.tidyverse.org/)                | better functional programming                                     |
| [forcats](https://forcats.tidyverse.org/index.html) | handle, clean, and manipulate categorical variables               |
| [haven](https://haven.tidyverse.org/)               | read and write data formats from proprietary statistical pacakges |

: Packages Included in Tidyverse

<br />

------------------------------------------------------------------------

# Part 2: Loading Data with Tidyverse

<br />

---

## Loading Data

<br />

---

### Tibble function: read_csv

this function allows you to read a csv file into a tibble data frame

```{r}
#| label: read_csv function
#| eval: false

sw_df <- read_csv("starwars.csv")

```

<br />

------------------------------------------------------------------------

### Readxl Package: Read Excel Files

this function allows you to read Excel files in a tibble data frame


```{r}
#| label: read excel files
#| eval: false
#| echo: true

horror_books <- readxl::read_xlsx("halloween.xlsx", sheet = 1)
horror_movies <- readxl::read_xlsx("halloween.xlsx", sheet = 2)
horror_articles <- readxl::read_xlsx("halloween.xlsx", sheet = 3)

```

<br />

---


### Haven package: Read non-proprietary data files

The package Haven allows you to read and export non-proprietary files
for SPSS, SAS, and STATA

```{r}
#| read spss - haven
#| eval: false


demographics_df <- haven::read_sav("demographics.sav")

```

<br />

---


### The Pipe Operator

The pipe operator allows you to run commands or operation on a single
object based on an order of operations

-   let's say you want to see the **name**, **height**, **mass**, and **species**
    of characters who were born on **Tatooine** department

```{r}
#| label: pipe operator example
#| eval: false

sw_df |> # object we are working on
  filter(homeworld == "Tatooine") |> # first operation
  select(name, height, mass, species) # second operation

# order of operations matter

sw_df |> # object we are working on
  select(name, height, mass, species) |> # first operation
  filter(homeworld == "Tatooine") # second operation

# why did this not work?


```

<br />

------------------------------------------------------------------------
### Tibble function: view

view the contents of a data frame in a separate viewer window or in the RStudio viewer pane.

```{r}
#| label: view function
#| eval: false

view(sw_df)

```

<br />

------------------------------------------------------------------------

#### Glimpse function

like the str() function in base r, this allow you see the structure of
your data but in a more compact manner

```{r}
#| label: glimpse function
#| eval: false

glimpse(sw_df)

```

<br />

------------------------------------------------------------------------

# Part 3: Cleaning Data

|                                                                   |                                                                |
|-----------------------|-------------------------------------------------|
| [filter](https://dplyr.tidyverse.org/reference/filter.html)       | retains or filters out observations based on variable criteria |
| [select](https://dplyr.tidyverse.org/reference/select.html)       | retains or filters out variables                               |
| [arrange](https://dplyr.tidyverse.org/reference/arrange.html)     | sorts variables                                                |
| [mutate](https://dplyr.tidyverse.org/reference/mutate.html)       | change variable's observations OR create a new variable and observations using observations from another variable                       |
| [group_by](https://dplyr.tidyverse.org/reference/group_by.html)   | group observations                                             |
| [summarise](https://dplyr.tidyverse.org/reference/summarise.html) | get descriptive statistics about a variable                    |

: Main Tidyverse Functions

<br />

------------------------------------------------------------------------


## Dplyr function: filter

the filter function allows you to *filter* your data frame using a
observations in a variable

```{r}
#| label: filter function
#| eval: false

sw_df

# let's filter the data frame so we are seeing characters who have blue eyes

sw_eye <- sw_df |> 
  filter(eye_color == "blue")

sw_eye

```

<br />

### Boolean operators

boolean operators allows you to build criteria in your code

|     |                       |
|-----|-----------------------|
| &   | AND                   |
| \|  | OR                    |
| ==  | EQUAL                 |
| !=  | NOT EQUAL             |
| \<  | LESS THAN             |
| \>  | GREATER THAN          |
| \<= | LESS THAN OR EQUAL    |
| \>= | GREATER THAN OR EQUAL |

: Boolean operators

<br />

```{r}
#| label: filter with more than one criteria
#| eval: false

# let's filter the data frame for characters who 
  # do have blue eyes 
    # and were born after 50 BBY

sw_eye50 <- sw_df |> 
  filter(eye_color == "blue" & birth_year < 50)

sw_eye50

```

<br />

------------------------------------------------------------------------

## Dplyr function: select

the select function allows you to *keep* or *discard* variables

```{r}
#| label: select function
#| eval: false

# keep variables

sw_select <- sw_df |> 
  select(name, height, mass)

sw_select

# remove variables

sw_not_select <- sw_df |> 
  select(-height, -mass)

sw_not_select

```

<br />

------------------------------------------------------------------------

## Dplyr function: mutate

the mutate function allows you to change variables OR create new
variables based on the observations in the variables

*NOTE: if you name your variable as an existing variable, it WILL overwrite the existing variable. If you give it a new name, it will create a new variable

```{r}
#| label: mutate function
#| eval: false

demographics_df

demographics_mutate <- demographics_df |> 
  mutate(income_new = income/1000) |>  # create new variable
  relocate(income_new, .after = income) # relocate variable in data frame

demographics_mutate

# let's overwrite the old variable

demographics_overwrite <- demographics_df |> 
  mutate(income = income/1000) # overwrite income variable

demographics_overwrite

```

<br />

------------------------------------------------------------------------

## Dplyr function: arrange

the arrange function allows you to sort variables

```{r}
#| label: arrange function
#| eval: false

# oldest characters

sw_df |> 
  arrange(desc(birth_year))

# characters with the same skin color than the same hair color

sw_df |> 
  arrange(desc(skin_color), hair_color)

```

<br />

---

## Dplyr function: group_by & summarise

the **group_by** function allows you to group common observations in a variable and **summarise** function allows you to get descriptive statistics about the groupings

```{r}
#| label: group_by and summarise
#| eval: false

sw_group <- sw_df |> 
  group_by(sex) |>
  summarise(avg_height = mean(height)) # get the mean of height for each group

sw_group

# you can add as many summaries as you want

sw_group <- sw_df |> 
  group_by(sex) |>
  summarise(avg_height = mean(height), # get the mean of height for each group
            count = n(), # get the count
            avg_bmi = mean(height/mass) # calculate bmi and get average
            ) 

```



<br />

------------------------------------------------------------------------

## Base Function: as.character 

The **as.** function along with **mutate** will allow you to change the
data type of a variable. For this example we are going to recode the
*character_id* variable to interpret the data type as a *character*
instead of a *double*

```{r}
#| label: data type recode
#| eval: false


sw_df <- sw_df |> 
  mutate(character_id = as.character(character_id))

sw_df

```

## Forcats function: as_factor

This function allows you to redefine a variable value as a factor using the **mutate** function.

```{r}
#| label: recode factors
#| eval: false

sw_df

sw_df <- sw_df |> 
  mutate(sex = as_factor(sex))

levels(sw_df$sex)

```


<br />

---

## Dyplr Function: recode

we can rename the values of observations within a variable using the **mutate** function in combination with the **recode** or **recode_factor** functions

```{r}
#| label: recode observations
#| eval: false

# let's create a new variable with to give numeric levels instead of value labels

sw_df <- sw_df |> 
  mutate(sex_num = recode_factor(sex,
                                 "male" = 0,
                                 "female" = 1,
                                 "none" = 2,
                                 "hermaphroditic" = 3,
                                 "unknown" = 999)) |> 
  relocate(sex_num, .after = sex)


sw_df
```

<br />

---

## Dplyr function: rename

the rename function allows you rename variables in your data frame

```{r}
#| label: rename
#| eval: false

glimpse(sw_df)

sw_df <- sw_df |> 
  rename("sex_label" = sex)

glimpse(sw_df)


```



<br />

---

## Tidyr function: drop_na

we can remove **all** missing data from data frames or variables using the drop_na function

```{r}
#| label: drop na
#| eval: false

# we can see if are data frame has missing NA values using the is.na function.

which(is.na(sw_df$mass))

# because there are missing values we cannot calculate some descriptive statistics

mean(sw_df$mass)

# we can drop all NA values from the data frame

sw_dropNA <- sw_df |> 
  drop_na()

mean(sw_dropNA$mass)

# we can also just drop NAs from a variable

sw_dropNA_var <- sw_df |> 
  drop_na(mass)

mean(sw_dropNA_var$mass)

```


<br />

---

## Tidyr function: replace_na

you can also recode the NA values for observations with the replace_na function

```{r}
#| label: replace_na
#| eval: false

# let's replace the NAs the homeworld variable with "unknown"

sw_df <- sw_df |> 
  mutate(homeworld = replace_na(homeworld, "unknown"))

sw_df

```

<br />

------------------------------------------------------------------------

## Readr function: write_csv

the write_csv function allows us to export data frames to a csv file
once we are done cleaning it up or when we have done some analysis that
we want to export

```{r}
#| label: exporting data
#| eval: false

# now that we have this date frame cleaned let's save it

# let's export the file

write_csv(sw_df, "starwars_clean.csv")

```

<br />

------------------------------------------------------------------------

## Haven function: Export as proprietary file

we can even export files that we have been working on as proprietary
files to work on in SPSS, SAS, or STATA

```{r}
#| label: export SPSS file
#| eval: false

# export to SPSS

haven::write_sav(sw_df, "starwars_clean.sav")

```

<br />

------------------------------------------------------------------------

# Part 4: Explore Your Data


-   [Psych Package](https://cran.r-project.org/web/packages/psych/index.html)

```{r}
#| label: Psych Package
#| eval: false

install.packages("psych")
library(psych)

```


```{r}
#| label: describe function
#| eval: false

describe(reviews_df)

```

-   [SummaryTools Package](https://cran.r-project.org/web/packages/summarytools/index.html)

```{r}
#| label: SummaryTools Package
#| eval: false

install.packages("summarytools")
library(summarytools)

```

```{r}
#| label: summarytools functions
#| eval: false

descr(reviews_df)

freq(reviews_df$Division_Name)

ctable(reviews_df$Recommended_IND, reviews_df$Division_Name)

```



-   [DataExplorer package](http://boxuancui.github.io/DataExplorer/)

```{r}
#| label: DataExplorer
#| eval: false

install.packages("DataExplorer")
library(DataExplorer)
```

```{r}
#| label: create report
#| eval: false

create_report(reviews_df)

```
